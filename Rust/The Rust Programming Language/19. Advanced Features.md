#2020-08 

# 19.1 `Unsafe`
5 个 Unsafe Superpowers:
- dereference raw pointer
- 调用其他 unsafe 的函数
- 操作 static mutable variable
- 实现 `unsafe trait`
- 访问 `union` 的 field

`unsafe` 不会：
- 取消 borrow checker
- 取消 safety check。

`unsafe` 用于 coder 知道没问题，但编译器不知道的时候。

## dereferencing a raw pointer
两种 raw pointer
- `* const T`
- `* mut T`

用 `as` 来从 reference 获得 raw pointer。注意这个是不需要 `unsafe` 的，因为定义一个指针本身没有什么问题。只有当需要 dereference 它的时候才是不安全的。
``` Rust
let mut a = 3;
let b : &a     as * const i32; // <--- 不在 unsafe 里
let c : &mut a as * mut i32;   // <--- 不在 unsafe 里

let d = 0x12345678usize;
let e = d as * const i32;

unsafe {
	println!("{}", *c); // <--- 注意 immutable 和 mutable 同时使用
	println!("{}", *b); // <--- 注意 immutable 和 mutable 同时使用
	println!("{}", *e); // <--- 可能会 crash
}
```

## calling unsafe functions/methods
``` Rsut
unsafe fn foo() {}

unsafe {
	foo();
}
```

``` Rust
fn split(slice: &mut [i32], mid: usize) -> (&mut [i32], &mut [i32]) {
    let len = slice.len();

    assert!(mid <= len);                      // <--- 这个保证下面 unsafe 实际上 是 safe 的

    // (&mut slice[..mid], &mut slice[mid..]) // <--- 编译错误，因一个 slice 两个 &mut
	unsafe {                                  // <--- 需要这样
        (
            slice::from_raw_parts_mut(ptr, mid),
            slice::from_raw_parts_mut(ptr.add(mid), len - mid),
        )
    }
}
```

### FFI
FFI: Foreign Function Interface
``` Rust
extern "C" { fn abs(input: i32) -> i32; }         // <--- 调用别人

#[no_mangle] pub extern "C" fn call_from_c() {}   // <--- 被别人调

fn main() {
    unsafe {  // <--- 调用别人需要 unsafe
        println!("Absolute value of -3 according to C: {}", abs(-3));
    }
}
```

## static mutable varible
``` Rust
static mut COUNTER: u32 = 0; // <--- 无法避免 data race

fn add_to_count(inc: u32) {
    unsafe {
        COUNTER += inc;       // <--- 修改需要 unsafe
    }
}

fn main() {
    add_to_count(3);

    unsafe {
        println!("COUNTER: {}", COUNTER); // <--- 读取也需要 unsafe
    }
}
```

## Implementing an Unsafe Trait
我觉得这里语焉不详
``` Rust
unsafe trait Foo {
    // methods go here
}

unsafe impl Foo for i32 {
    // method implementations go here
}

fn main() {}
```

## Accessing Fields of a Union
我觉得这里语焉不详


